@page "/shopping-list"
@attribute [Authorize]
@inject SupabaseService Supabase
@inject SupabaseAuthStateProvider AuthStateProvider
@inject NavigationManager Nav

<PageTitle>Shopping List â€” NineWest</PageTitle>

<div class="sl-page">
    <div class="sl-header">
        <div>
            <h1>ðŸ›’ Shopping List</h1>
            <span class="sl-sub">@_items.Count item@(_items.Count != 1 ? "s" : "")</span>
        </div>
        <button class="btn btn-outline-secondary btn-sm" @onclick="SignOut">Sign out</button>
    </div>

    <div class="sl-add">
        <input class="form-control sl-input"
               @bind="_newName"
               @bind:event="oninput"
               @onkeydown="HandleKeyDown"
               placeholder="Add an itemâ€¦"
               disabled="@_adding" />
        <input class="form-control sl-qty"
               @bind="_newQty"
               @bind:event="oninput"
               placeholder="Qty"
               disabled="@_adding" />
        <button class="btn btn-primary sl-btn"
                @onclick="AddItem"
                disabled="@(string.IsNullOrWhiteSpace(_newName) || _adding)">
            @if (_adding)
            {
                <span class="spinner-border spinner-border-sm" role="status" />
            }
            else
            {
                <span>ï¼‹</span>
            }
        </button>
    </div>

    @if (_errorMessage is not null)
    {
        <div class="alert alert-danger mt-2">
            @_errorMessage
            <button type="button" class="btn-close btn-close-sm sl-alert-close" @onclick="() => _errorMessage = null" />
        </div>
    }

    @if (_loading)
    {
        <div class="sl-loading">
            <span class="spinner-border text-primary" role="status" />
        </div>
    }
    else if (_items.Count == 0)
    {
        <div class="sl-empty">
            <span class="sl-empty-icon">ðŸ§º</span>
            <p>Your list is empty â€” add something above!</p>
        </div>
    }
    else
    {
        <ul class="sl-list">
            @foreach (var item in UncheckedItems)
            {
                <li class="sl-item">
                    <input type="checkbox" class="form-check-input sl-check"
                           checked="@item.IsChecked"
                           @onchange="() => ToggleItem(item)" />
                    <div class="sl-item-info">
                        <span class="sl-item-name">@item.Name</span>
                        @if (!string.IsNullOrWhiteSpace(item.Quantity))
                        {
                            <span class="sl-item-qty">@item.Quantity</span>
                        }
                    </div>
                    <button class="sl-delete" @onclick="() => DeleteItem(item)" title="Remove">âœ•</button>
                </li>
            }

            @if (CheckedItems.Any())
            {
                <li class="sl-divider">
                    <span>Checked (@CheckedItems.Count())</span>
                    <button class="btn btn-link btn-sm p-0 sl-clear-btn" @onclick="ClearChecked">Clear all</button>
                </li>
                @foreach (var item in CheckedItems)
                {
                    <li class="sl-item sl-checked">
                        <input type="checkbox" class="form-check-input sl-check"
                               checked="@item.IsChecked"
                               @onchange="() => ToggleItem(item)" />
                        <div class="sl-item-info">
                            <span class="sl-item-name">@item.Name</span>
                            @if (!string.IsNullOrWhiteSpace(item.Quantity))
                            {
                                <span class="sl-item-qty">@item.Quantity</span>
                            }
                        </div>
                        <button class="sl-delete" @onclick="() => DeleteItem(item)" title="Remove">âœ•</button>
                    </li>
                }
            }
        </ul>
    }
</div>

@code {
    private List<ShoppingListItem> _items = [];
    private string _newName = string.Empty;
    private string _newQty = string.Empty;
    private bool _loading = true;
    private bool _adding;
    private string? _errorMessage;

    private IEnumerable<ShoppingListItem> UncheckedItems => _items.Where(i => !i.IsChecked);
    private IEnumerable<ShoppingListItem> CheckedItems => _items.Where(i => i.IsChecked);

    protected override async Task OnInitializedAsync() => await LoadItems();

    private async Task LoadItems()
    {
        try
        {
            _items = await Supabase.GetShoppingListAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task AddItem()
    {
        if (string.IsNullOrWhiteSpace(_newName)) return;

        _adding = true;
        _errorMessage = null;

        try
        {
            var item = await Supabase.AddItemAsync(_newName, _newQty);
            if (item is not null)
            {
                _items.Add(item);
                _newName = string.Empty;
                _newQty = string.Empty;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _adding = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await AddItem();
    }

    private async Task ToggleItem(ShoppingListItem item)
    {
        try
        {
            await Supabase.ToggleItemAsync(item);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private async Task DeleteItem(ShoppingListItem item)
    {
        try
        {
            await Supabase.DeleteItemAsync(item);
            _items.Remove(item);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private async Task ClearChecked()
    {
        foreach (var item in CheckedItems.ToList())
            await DeleteItem(item);
    }

    private async Task SignOut()
    {
        await Supabase.SignOutAsync();
        AuthStateProvider.NotifyAuthStateChanged();
        Nav.NavigateTo("/login");
    }
}
